---

- name: Package prerequisites for node.js
  apt: pkg=python-software-properties state=installed
  sudo: yes

- name: Add the node.js PPA
  command: add-apt-repository -y ppa:chris-lea/node.js creates=/etc/apt/sources.list.d/chris-lea-node_js-precise.list
  sudo: yes

- name: Install nodejs (with npm)
  action: apt pkg=nodejs state=installed update-cache=yes
  sudo: yes

- name: Install required Node.js packages.
  npm: name={{ item }} global=yes
  with_items:
    - grunt-cli
  sudo: yes

- name: Create the /var/www directory and set it as belonging to the www-data user.
  file: dest=/var/www owner=www-data state=directory
  sudo: yes

- name: Clone the FLE Site git repository and checkout the desired branch.
  git: repo=https://github.com/fle-internal/fle-site.git version={{ fle_site_git_branch }} dest={{ fle_site_path }}
  sudo: yes
  sudo_user: www-data
  register: flesite_clone
  notify: restart apache2
  tags:
    -- update_fle_site

- name: Install required Node.js packages.
  npm: name={{ item }} path={{ fle_site_path }}
  with_items:
    - grunt
    - less
    - grunt-contrib-less
  sudo: yes
  sudo_user: www-data

- name: Compile the static KA Lite resources by running the Gruntfile.
  command: grunt chdir={{ fle_site_path }}
  sudo: yes
  sudo_user: www-data
  changed_when: False
  when: flesite_clone.changed
  tags:
    -- update_fle_site

- name: Put the local_settings.py file into the FLE Site project directory.
  template: src=local_settings.py.j2 dest={{ fle_site_path }}/fle_site/local_settings.py
  sudo: yes
  sudo_user: www-data
  notify: restart apache2
  tags:
    -- update_fle_site

- name: Ensure a local_settings_secret.py file exists.
  sudo: yes
  sudo_user: www-data
  command: touch {{ fle_site_path }}/fle_site/local_settings_secrets.py creates={{ fle_site_path }}/fle_site/local_settings_secrets.py
  tags:
    -- update_fle_site

- name: Update the SECRET_KEY in local_settings_secret.py if variable 'fle_site_secret_key' is defined.
  lineinfile: dest={{ fle_site_path }}/fle_site/local_settings_secrets.py regexp='^SECRET_KEY =' line='SECRET_KEY = "{{ fle_site_secret_key }}"' owner="www-data"
  sudo: yes
  sudo_user: www-data
  when: fle_site_secret_key is defined
  tags:
    -- update_fle_site

- name: Update the DATABASE_PASSWORD in local_settings_secret.py if variable 'fle_site_db_pass' is defined.
  lineinfile: dest={{ fle_site_path }}/fle_site/local_settings_secrets.py regexp='^DATABASE_PASSWORD =' line='DATABASE_PASSWORD = "{{ fle_site_db_pass }}"' owner="www-data"
  sudo: yes
  sudo_user: www-data
  when: fle_site_db_pass is defined
  tags:
    -- update_fle_site

- name: Update the DISQUS_USER_API_KEY in local_settings_secret.py if variable 'disqus_user_api_key' is defined.
  lineinfile: dest={{ fle_site_path }}/fle_site/local_settings_secrets.py regexp='^DISQUS_USER_API_KEY =' line='DISQUS_USER_API_KEY = "{{ disqus_user_api_key }}"' owner="www-data"
  sudo: yes
  sudo_user: www-data
  when: disqus_user_api_key is defined
  tags:
    -- update_fle_site

- name: Copy GeoLiteCity file onto server.
  copy: src=GeoLiteCity.dat dest={{ fle_site_path }}/fle_site/data/GeoLiteCity.dat
  sudo: yes
  sudo_user: www-data

- name: Install Python package requirements
  pip: requirements={{ fle_site_path }}/requirements.txt
  sudo: yes

- name: Find the location of the installed Django package.
  command: "python -c 'import os, django; print os.path.dirname(django.__file__)'"
  register: django_location
  changed_when: False

- name: Setup general Apache config file.
  template: src=apache2.conf.j2 dest=/etc/apache2/apache2.conf
  sudo: yes
  notify: restart apache2

- name: Setup Apache ports config file.
  template: src=apache-ports.conf.j2 dest=/etc/apache2/ports.conf
  sudo: yes
  notify: restart apache2

- name: Setup FLE Site Apache site conf file.
  template: src=fle-site-apache2-site.j2 dest=/etc/apache2/sites-available/002-fle_site
  sudo: yes
  notify: restart apache2

- name: Enable the FLE Site Apache site.
  file: dest=/etc/apache2/sites-enabled/002-fle_site src=/etc/apache2/sites-available/002-fle_site state=link
  sudo: yes
  notify: restart apache2

- name: Remove default dummy Apache conf file.
  file: dest=/etc/apache2/sites-enabled/000-default state=absent
  sudo: yes
  notify: restart apache2

- name: Clear any old pyc files left over from an old branch or version.
  shell: "{{ fle_site_path }}/manage.py clean_pyc"
  sudo: yes
  changed_when: False
  tags:
    -- update_fle_site

- name: Run syncdb on FLE Site database to ensure it is initialized.
  shell: "{{ fle_site_path }}/manage.py syncdb --noinput"
  register: syncdb
  changed_when: "'Creating table ' in syncdb.stdout"
  tags:
    -- update_fle_site

- name: Migrate FLE Site database to latest schema.
  shell: "{{ fle_site_path }}/manage.py migrate --merge"
  register: migrate
  changed_when: "'Migrating forwards' in migrate.stdout"
  tags:
    -- update_fle_site

- name: Run collectstatic to consolidate static files from all apps.
  shell: "{{ fle_site_path }}/manage.py collectstatic --noinput"
  sudo: yes
  sudo_user: www-data
  tags:
    -- update_fle_site

- name: Create Django superuser for FLE Site if needed.
  shell: "{{ fle_site_path }}/manage.py createsuperuser --email=admin@learningequality.org --username={{ fle_site_django_superuser_name }} --noinput"
  when: fle_site_django_superuser_name is defined
  register: createsuperuser
  changed_when: "'Duplicate entry' not in createsuperuser.stderr"
  failed_when: "createsuperuser.stderr and 'Duplicate entry' not in createsuperuser.stderr"

- name: Set Django superuser password for FLE Site if needed.
  shell: "echo 'from django.contrib.auth.models import User; u = User.objects.get(username=\"{{ fle_site_django_superuser_name }}\"); print \"same_password\" if u.check_password(\"{{ fle_site_django_superuser_pass }}\") else \"changed_password\"; u.set_password(\"{{ fle_site_django_superuser_pass }}\"); u.save()' | {{ fle_site_path }}/manage.py shell"
  when: fle_site_django_superuser_name is defined and fle_site_django_superuser_pass is defined
  register: setpassword
  changed_when: "'changed_password' in setpassword.stdout"

# - name: Load fixture 1.
#   shell: "{{ fle_site_path }}/manage.py loaddata supporting_organization.json"

# - name: Load fixture 2.
#   shell: "{{ fle_site_path }}/manage.py loaddata org_type.json"

- name: Clone the KA Lite presentation and checkout the desired branch.
  git: repo=https://github.com/jamalex/ka-lite-presentation.git version={{ ka_lite_presentation_git_branch }} dest={{ ka_lite_presentation_path }}
  sudo: yes
  sudo_user: www-data
  notify: restart apache2
